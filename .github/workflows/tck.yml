name: tck
on: 
  schedule:
  - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      version:
        description: 'Piranha Version'
        required: true
        default: '25.2.0-SNAPSHOT'
jobs:
  annotations:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        java: [ '21' ]
        os: [ubuntu-latest]
    steps:
    - name: Checkout Sources
      uses: actions/checkout@v4
    - name: Set up Java ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java }}
    - name: Run TCK
      run: |
        mvn -N install
        cd annotations
        mvn -B -ntp verify
    - name: Test Summary
      uses: test-summary/action@v2
      with:
        paths: "annotations/runner/target/failsafe-reports/*IT.xml"
      if: always()
  cdi:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        java: [ '21' ]
        os: [ubuntu-latest]
    steps:
    - name: Checkout Sources
      uses: actions/checkout@v4
    - name: Set up Java ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java }}
    - name: Run TCK
      run: |
        mvn -N install
        cd cdi
        mvn -B -ntp -T 1 verify
    - name: Test Summary
      uses: test-summary/action@v2
      with:
        paths: |
          cdi/runner/core/target/surefire-reports/junitreports/TEST-*.xml
          cdi/runner/model/target/surefire-reports/TEST-*.xml
      if: always()
  coreprofile:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        java: [ '21' ]
        os: [ubuntu-latest]
    steps:
    - name: Checkout Sources
      uses: actions/checkout@v4
    - name: Set up Java ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java }}
    - name: Run TCK
      run: |
        mvn -N install
        cd coreprofile
        mvn -B -Dmaven.test.failure.ignore=true -ntp verify        
    - name: Test Summary
      uses: test-summary/action@v2
      with:
        paths: "coreprofile/runner/target/failsafe-reports/**/TEST-*.xml"
      if: always()
  inject:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        java: [ '21' ]
        os: [ubuntu-latest]
    steps:
    - name: Checkout Sources
      uses: actions/checkout@v4
    - name: Set up Java ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java }}
    - name: Run TCK
      run: |
        mvn -N install
        cd inject
        mvn -B -ntp verify
    - name: Test Summary
      uses: test-summary/action@v2
      with:
        paths: "inject/installer/target/tck/example/target/surefire-reports/TEST-*.xml"
      if: always()
  jsonb:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        java: [ '21' ]
        os: [ubuntu-latest]
    steps:
    - name: Checkout Sources
      uses: actions/checkout@v4
    - name: Set up Java ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java }}
    - name: Run TCK
      run: |
        mvn -N install
        cd jsonb
        mvn -B -ntp verify
    - name: Test Summary
      uses: test-summary/action@v2
      with:
        paths: "jsonb/installer/target/tck/bin/target/surefire-reports/TEST-*.xml"
      if: always()
  jsonp:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        java: [ '21' ]
        os: [ubuntu-latest]
    steps:
    - name: Checkout Sources
      uses: actions/checkout@v4
    - name: Set up Java ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java }}
    - name: Run TCK
      run: |
        mvn -N install
        cd jsonp
        mvn -B -ntp verify
    - name: Test Summary
      uses: test-summary/action@v2
      with:
        paths: |
          jsonp/installer/target/tck/bin/tck-tests/target/surefire-reports/TEST-*.xml
          jsonp/installer/target/tck/bin/tck-tests-pluggability/target/surefire-reports/TEST-*.xml
      if: always()
  rest:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        java: [ '21' ]
        os: [ubuntu-latest]
    steps:
    - name: Checkout Sources
      uses: actions/checkout@v4
    - name: Set up Java ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java }}
    - name: Run TCK
      run: |
        export VERSION=${{ github.event.inputs.version }}
        mvn -N -T 1 install
        mvn dependency:get -N -T 1 -Dartifact=cloud.piranha.dist:piranha-dist-coreprofile:$VERSION:jar -DremoteRepositories=oss::default::https://oss.sonatype.org/content/repositories/snapshots/ 
        cd rest
        mvn -B -Dpiranha.version=$VERSION -ntp -T 1 verify        
    - name: Test Summary
      uses: test-summary/action@v2
      id: test_summary
      with:
        paths: "rest/runner/target/failsafe-reports/**/TEST-*.xml"
        output: test-summary.md
      if: always()
    - name: Job Summary
      run: |
        echo "${{ steps.test_summary.outputs.passed }} out of ${{ steps.test_summary.outputs.total }} tests passed" >> $GITHUB_STEP_SUMMARY
      if: always()
